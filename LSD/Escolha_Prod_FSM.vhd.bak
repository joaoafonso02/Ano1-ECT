library IEEE;
use IEEE.STD_LOGIC_1164.all;

entity Escolha_Prod_FSM is
	port(reset		: in  std_logic;
		  clk		: in  std_logic;
		  
		  -- sinais de comunicação com o timer
		  newTime	: out std_logic; -- valor que indica ao timer para começar a contar
		  timeVal	: out std_logic_vector(7 downto 0); -- valor que passa ao timer quanto tempo esperar
		  timeExp	: in  std_logic; -- indica que o timer já acabou
		  
		  -- pins de seleção
		  p_Fan : in std_logic; 
		  p_SULI : in std_logic;
		  p_SPES : in std_logic;
		  
		  -- Leds de informação
		  l_Done : out std_logic
		  
		  
		 );
end Escolha_Prod_FSM;

architecture Behavioral of Escolha_Prod_FSM is
	
	-- Constantes de tempo
	constant BOOT_TIME				: std_logic_vector(7 downto 0) := "00000110"; -- 6 s
	constant PREP_TIME				: std_logic_vector(7 downto 0) := "00001000"; -- 8 s
	constant DONE_TIME				: std_logic_vector(7 downto 0) := "00000010"; -- 2 s


	type TState is (Boot,Option,Done,St_Fan,St_Suli,St_Spes);
	signal s_currentState, s_nextState	: TState := Boot;
	signal s_stateChanged : std_logic := '1';

begin
	sync_proc : process(clk)
	begin
		if (rising_edge(clk)) then
			if (reset = '1') then
				s_currentState <= Boot;
				s_stateChanged <= '1';
			else
				if (s_currentState /= s_nextState) then
					s_stateChanged <= '1';
				else
					s_stateChanged <= '0';
				end if;
				s_currentState	<= s_nextState;
			end if;
		end if;
	end process;

	newTime <= s_stateChanged;
	

	comb_proc : process(s_currentState, Boot,p_spes,p_suli,p_fan, timeExp)
	begin
		case (s_currentState) is
		when Boot =>
		
			timeVal	<= BOOT_TIME;
		
			if (timeExp = '1') then
			
				s_nextState <= Option;
			else
				s_nextState <= Boot;
			end if;
			
		when Option =>
			
			timeVal	<= (others => '-');
			
			if (p_Fan = '1') then
				s_nextState <= St_Fan;
			elsif(p_SULI = '1') then
				s_nextState <= St_Suli;
			elsif(p_SPES = '1') then
				s_nextState <= St_Spes;
			else
				s_nextState <= Option;
			end if;
		
		when Done =>	-- acende o led informação durante 2 seg e depois para para o estado de escolher bebida
			timeVal <= DONE_TIME;
			l_Done <= '1';
			
			if (timeExp = '1') then
				s_nextState <= Option;
			else
				s_nextState <= Done;
			end if;
			
		when St_Fan =>
			timeVal <= PREP_TIME;

			if (timeExp = '1') then
				s_nextState <= Done;
			else
				s_nextState <= St_Fan;
			end if;
		
		when St_Spes =>
			timeVal <= PREP_TIME;
			
			if (timeExp = '1') then
				s_nextState <= Done;
			else
				s_nextState <= St_Spes;
			end if;
		
		when St_Suli =>
			timeVal <= PREP_TIME;
			
			if (timeExp = '1') then
				s_nextState <= Done;
			else
				s_nextState <= St_Suli;
			end if;
		
		end case;
	end process;
end Behavioral;